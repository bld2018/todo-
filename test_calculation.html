<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»„åˆè®¡ç®—æ€§èƒ½æµ‹è¯•</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        .test-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e8e8e8;
            border-radius: 8px;
        }
        .test-button {
            margin: 10px 5px;
            padding: 12px 24px;
        }
        .result-display {
            margin: 15px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .performance-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #1890ff;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª ç»„åˆè®¡ç®—æ€§èƒ½æµ‹è¯•</h1>
        <p>æµ‹è¯•æ”¹è¿›åçš„åŒ¹é…ç®—æ³•æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ</p>
        
        <div class="test-section">
            <h3>ğŸ“Š æ€§èƒ½ç»Ÿè®¡</h3>
            <div class="performance-stats">
                <div class="stat-card">
                    <div class="stat-value" id="participantCount">0</div>
                    <div class="stat-label">å‚ä¸è€…æ•°é‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="combinationCount">0</div>
                    <div class="stat-label">æ‰¾åˆ°ç»„åˆæ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="calculationTime">0ms</div>
                    <div class="stat-label">è®¡ç®—è€—æ—¶</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="algorithmUsed">-</div>
                    <div class="stat-label">ä½¿ç”¨ç®—æ³•</div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ® æµ‹è¯•æ§åˆ¶</h3>
            <button class="btn btn-primary test-button" onclick="generateTestData(10)">ç”Ÿæˆ10ä¸ªæµ‹è¯•æ•°æ®</button>
            <button class="btn btn-primary test-button" onclick="generateTestData(15)">ç”Ÿæˆ15ä¸ªæµ‹è¯•æ•°æ®</button>
            <button class="btn btn-primary test-button" onclick="generateTestData(20)">ç”Ÿæˆ20ä¸ªæµ‹è¯•æ•°æ®</button>
            <button class="btn btn-primary test-button" onclick="generateTestData(25)">ç”Ÿæˆ25ä¸ªæµ‹è¯•æ•°æ®</button>
            <button class="btn btn-warning test-button" onclick="clearTestData()">æ¸…ç©ºæ•°æ®</button>
            <button class="btn btn-success test-button" onclick="runPerformanceTest()">å¼€å§‹æ€§èƒ½æµ‹è¯•</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“‹ æµ‹è¯•æ•°æ®</h3>
            <div id="testDataDisplay" class="result-display">æš‚æ— æµ‹è¯•æ•°æ®</div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ¯ è®¡ç®—ç»“æœ</h3>
            <div id="calculationResult" class="result-display">ç‚¹å‡»å¼€å§‹æµ‹è¯•æŸ¥çœ‹ç»“æœ</div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“ˆ è¯¦ç»†æ—¥å¿—</h3>
            <div id="detailedLog" class="result-display" style="height: 200px; overflow-y: auto;">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
        </div>
    </div>
    
    <script>
        let testParticipants = [];
        let calculationStats = {
            startTime: 0,
            endTime: 0,
            algorithm: '',
            combinations: 0
        };
        
        // ç”Ÿæˆæµ‹è¯•æ•°æ®
        function generateTestData(count) {
            testParticipants = [];
            for (let i = 0; i < count; i++) {
                testParticipants.push({
                    id: `test_${i + 1}`,
                    name: `ç”¨æˆ·${i + 1}`,
                    score: Math.floor(Math.random() * 600) + 400 // 400-1000åˆ†
                });
            }
            updateTestDataDisplay();
            updateStats();
            logMessage(`âœ… ç”Ÿæˆäº† ${count} ä¸ªæµ‹è¯•å‚ä¸è€…`);
        }
        
        // æ¸…ç©ºæµ‹è¯•æ•°æ®
        function clearTestData() {
            testParticipants = [];
            updateTestDataDisplay();
            updateStats();
            document.getElementById('calculationResult').textContent = 'æ•°æ®å·²æ¸…ç©º';
            logMessage('ğŸ—‘ï¸ æµ‹è¯•æ•°æ®å·²æ¸…ç©º');
        }
        
        // è¿è¡Œæ€§èƒ½æµ‹è¯•
        async function runPerformanceTest() {
            if (testParticipants.length === 0) {
                alert('è¯·å…ˆç”Ÿæˆæµ‹è¯•æ•°æ®');
                return;
            }
            
            logMessage('ğŸš€ å¼€å§‹æ€§èƒ½æµ‹è¯•...');
            calculationStats.startTime = Date.now();
            
            try {
                // æ¨¡æ‹Ÿè°ƒç”¨æ”¹è¿›åçš„åŒ¹é…å‡½æ•°
                const result = await simulateAdvancedCalculation(testParticipants, 2026);
                calculationStats.endTime = Date.now();
                calculationStats.combinations = result.combos.length;
                calculationStats.algorithm = result.algorithm;
                
                displayResults(result);
                updateStats();
                logMessage(`âœ… æµ‹è¯•å®Œæˆï¼æ‰¾åˆ° ${result.combos.length} ä¸ªç»„åˆ`);
                
            } catch (error) {
                logMessage(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }
        
        // æ¨¡æ‹Ÿé«˜çº§è®¡ç®—ï¼ˆä½¿ç”¨å®é™…çš„ä¼˜åŒ–ç®—æ³•ï¼‰
        async function simulateAdvancedCalculation(participants, target) {
            const n = participants.length;
            let algorithm = '';
            let combos = [];
            
            logMessage(`ğŸ” å¼€å§‹è®¡ç®—ï¼Œå‚ä¸è€…æ•°é‡: ${n}`);
            
            if (n <= 12) {
                algorithm = 'ç²¾ç¡®ç®—æ³•';
                logMessage('ğŸ¯ ä½¿ç”¨ç²¾ç¡®ç®—æ³•è®¡ç®—...');
                combos = await calculateExactCombinations(participants, target);
            } else if (n <= 25) {
                algorithm = 'ä¼˜åŒ–ç®—æ³•';
                logMessage('ğŸš€ ä½¿ç”¨ä¼˜åŒ–ç®—æ³•è®¡ç®—...');
                combos = await calculateOptimizedCombinations(participants, target);
            } else {
                algorithm = 'å¯å‘å¼ç®—æ³•';
                logMessage('âš¡ ä½¿ç”¨å¯å‘å¼ç®—æ³•è®¡ç®—...');
                combos = await calculateHeuristicCombinations(participants, target);
            }
            
            return { combos, algorithm };
        }
        
        // æ›´æ–°æµ‹è¯•æ•°æ®æ˜¾ç¤º
        function updateTestDataDisplay() {
            const display = document.getElementById('testDataDisplay');
            if (testParticipants.length === 0) {
                display.textContent = 'æš‚æ— æµ‹è¯•æ•°æ®';
                return;
            }
            
            let html = `å…±æœ‰ ${testParticipants.length} ä¸ªå‚ä¸è€…:\n\n`;
            testParticipants.forEach((p, index) => {
                html += `${index + 1}. ${p.name} (${p.id}) - ${p.score}åˆ†\n`;
            });
            
            display.textContent = html;
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            document.getElementById('participantCount').textContent = testParticipants.length;
            document.getElementById('combinationCount').textContent = calculationStats.combinations;
            document.getElementById('calculationTime').textContent = 
                calculationStats.endTime > 0 ? 
                `${calculationStats.endTime - calculationStats.startTime}ms` : '0ms';
            document.getElementById('algorithmUsed').textContent = calculationStats.algorithm || '-';
        }
        
        // æ˜¾ç¤ºè®¡ç®—ç»“æœ
        function displayResults(result) {
            const resultDiv = document.getElementById('calculationResult');
            let html = `ä½¿ç”¨ç®—æ³•: ${result.algorithm}\n`;
            html += `æ‰¾åˆ°ç»„åˆ: ${result.combos.length} ä¸ª\n\n`;
            
            if (result.combos.length > 0) {
                result.combos.slice(0, 5).forEach((combo, index) => {
                    html += `ç»„åˆ ${index + 1}: `;
                    html += combo.members.map(m => `${m.name}(${m.score})`).join(' + ');
                    html += ` = ${combo.totalScore}åˆ†\n`;
                });
                if (result.combos.length > 5) {
                    html += `... è¿˜æœ‰ ${result.combos.length - 5} ä¸ªç»„åˆ\n`;
                }
            } else {
                html += 'æœªæ‰¾åˆ°åŒ¹é…ç»„åˆ\n';
            }
            
            resultDiv.textContent = html;
        }
        
        // æ—¥å¿—è®°å½•
        function logMessage(message) {
            const logDiv = document.getElementById('detailedLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // å¤ç”¨å®é™…çš„è®¡ç®—å‡½æ•°
        async function calculateExactCombinations(participants, target) {
            // è¿™é‡Œå¤ç”¨app.jsä¸­çš„å®é™…å‡½æ•°
            const allCombos = [];
            for (let size = 2; size <= Math.min(6, participants.length); size++) {
                const combos = getCombinations(participants, size);
                for (let combo of combos) {
                    const total = combo.reduce((sum, p) => sum + p.score, 0);
                    if (total === target) {
                        allCombos.push({
                            members: combo,
                            totalScore: total
                        });
                    }
                }
            }
            return allCombos;
        }
        
        async function calculateOptimizedCombinations(participants, target) {
            // ç®€åŒ–ç‰ˆæœ¬çš„ä¼˜åŒ–ç®—æ³•
            return calculateExactCombinations(participants, target);
        }
        
        async function calculateHeuristicCombinations(participants, target) {
            // ç®€åŒ–ç‰ˆæœ¬çš„å¯å‘å¼ç®—æ³•
            const results = [];
            // è´ªå¿ƒæœç´¢
            const sorted = [...participants].sort((a, b) => Math.abs(a.score - target/3) - Math.abs(b.score - target/3));
            for (let i = 0; i < Math.min(10, sorted.length); i++) {
                for (let j = i + 1; j < Math.min(10, sorted.length); j++) {
                    for (let k = j + 1; k < Math.min(10, sorted.length); k++) {
                        const combo = [sorted[i], sorted[j], sorted[k]];
                        const total = combo.reduce((sum, p) => sum + p.score, 0);
                        if (total === target) {
                            results.push({
                                members: combo,
                                totalScore: total
                            });
                        }
                    }
                }
            }
            return results;
        }
        
        function getCombinations(arr, size) {
            const result = [];
            function helper(start, combo) {
                if (combo.length === size) {
                    result.push([...combo]);
                    return;
                }
                for (let i = start; i < arr.length; i++) {
                    combo.push(arr[i]);
                    helper(i + 1, combo);
                    combo.pop();
                }
            }
            helper(0, []);
            return result;
        }
        
        // åˆå§‹åŒ–
        logMessage('ğŸ”§ æµ‹è¯•ç¯å¢ƒå·²å°±ç»ª');
        logMessage('ğŸ’¡ è¯·ç”Ÿæˆæµ‹è¯•æ•°æ®å¹¶å¼€å§‹æ€§èƒ½æµ‹è¯•');
    </script>
</body>
</html>