<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿæ€§èƒ½ç›‘æ§</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .dashboard { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        .card { 
            background: #fff; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
        }
        .metric { 
            text-align: center; 
            margin: 15px 0; 
        }
        .metric-value { 
            font-size: 2em; 
            font-weight: bold; 
            color: #1890ff; 
        }
        .metric-label { 
            color: #666; 
            margin-top: 5px; 
        }
        .status-indicator { 
            display: inline-block; 
            width: 12px; 
            height: 12px; 
            border-radius: 50%; 
            margin-right: 8px; 
        }
        .status-normal { background: #52c41a; }
        .status-warning { background: #faad14; }
        .status-error { background: #ff4d4f; }
        .chart-container { 
            height: 200px; 
            background: #fafafa; 
            border-radius: 4px; 
            display: flex; 
            align-items: flex-end; 
            padding: 10px; 
            gap: 2px; 
        }
        .chart-bar { 
            flex: 1; 
            background: #1890ff; 
            border-radius: 2px 2px 0 0; 
            min-height: 1px; 
            transition: height 0.3s ease; 
        }
        .queue-list { 
            max-height: 200px; 
            overflow-y: auto; 
            border: 1px solid #eee; 
            border-radius: 4px; 
            padding: 10px; 
        }
        .queue-item { 
            padding: 8px; 
            margin: 5px 0; 
            background: #f9f9f9; 
            border-radius: 4px; 
            display: flex; 
            justify-content: space-between; 
        }
        .refresh-btn { 
            background: #1890ff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 10px 5px; 
        }
        .refresh-btn:hover { 
            background: #40a9ff; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š ç³»ç»Ÿæ€§èƒ½ç›‘æ§é¢æ¿</h1>
        <p>å®æ—¶ç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€å’Œæ€§èƒ½æŒ‡æ ‡</p>
        
        <div class="dashboard">
            <div class="card">
                <h3>ğŸš€ ç³»ç»ŸçŠ¶æ€</h3>
                <div class="metric">
                    <div>
                        <span class="status-indicator status-normal" id="systemStatus"></span>
                        <span id="systemStatusText">æ­£å¸¸è¿è¡Œ</span>
                    </div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="activeUsers">0</div>
                    <div class="metric-label">å½“å‰åœ¨çº¿ç”¨æˆ·</div>
                </div>
            </div>
            
            <div class="card">
                <h3>ğŸ“‹ é˜Ÿåˆ—çŠ¶æ€</h3>
                <div class="metric">
                    <div class="metric-value" id="queueLength">0</div>
                    <div class="metric-label">å¾…å¤„ç†è¯·æ±‚æ•°</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="runningTasks">0</div>
                    <div class="metric-label">æ­£åœ¨æ‰§è¡Œä»»åŠ¡</div>
                </div>
            </div>
            
            <div class="card">
                <h3>âš¡ æ€§èƒ½æŒ‡æ ‡</h3>
                <div class="metric">
                    <div class="metric-value" id="avgResponseTime">0</div>
                    <div class="metric-label">å¹³å‡å“åº”æ—¶é—´(ms)</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="cacheHitRate">0%</div>
                    <div class="metric-label">ç¼“å­˜å‘½ä¸­ç‡</div>
                </div>
            </div>
            
            <div class="card">
                <h3>ğŸ’¾ æ•°æ®ç»Ÿè®¡</h3>
                <div class="metric">
                    <div class="metric-value" id="totalParticipants">0</div>
                    <div class="metric-label">æ€»å‚ä¸è€…æ•°</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="todayOperations">0</div>
                    <div class="metric-label">ä»Šæ—¥æ“ä½œæ•°</div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h3>ğŸ“ˆ è¯·æ±‚é˜Ÿåˆ—è¯¦æƒ…</h3>
            <div class="queue-list" id="queueDetails">
                <div style="text-align: center; color: #999; padding: 20px;">
                    æš‚æ— å¾…å¤„ç†è¯·æ±‚
                </div>
            </div>
        </div>
        
        <div class="card">
            <h3>ğŸ“Š å“åº”æ—¶é—´è¶‹åŠ¿</h3>
            <div class="chart-container" id="responseTimeChart">
                <!-- å›¾è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button class="refresh-btn" onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            <button class="refresh-btn" onclick="clearQueue()">ğŸ§¹ æ¸…ç©ºé˜Ÿåˆ—</button>
            <button class="refresh-btn" onclick="resetStats()">ğŸ“Š é‡ç½®ç»Ÿè®¡</button>
        </div>
    </div>

    <script>
        // æ€§èƒ½ç»Ÿè®¡æ•°æ®
        let performanceStats = {
            totalRequests: 0,
            successfulRequests: 0,
            failedRequests: 0,
            responseTimes: [],
            cacheHits: 0,
            cacheMisses: 0
        };
        
        // å“åº”æ—¶é—´å†å²æ•°æ®
        let responseTimeHistory = [];
        
        // åˆå§‹åŒ–ç›‘æ§
        function initMonitoring() {
            refreshData();
            setInterval(refreshData, 5000); // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡
            setInterval(updateCharts, 1000); // æ¯ç§’æ›´æ–°å›¾è¡¨
        }
        
        // åˆ·æ–°æ‰€æœ‰æ•°æ®
        async function refreshData() {
            try {
                // æ›´æ–°é˜Ÿåˆ—çŠ¶æ€
                updateQueueStatus();
                
                // æ›´æ–°æ€§èƒ½æŒ‡æ ‡
                updatePerformanceMetrics();
                
                // æ›´æ–°æ•°æ®ç»Ÿè®¡
                await updateDataStats();
                
            } catch (error) {
                console.error('ç›‘æ§æ•°æ®åˆ·æ–°å¤±è´¥:', error);
            }
        }
        
        // æ›´æ–°é˜Ÿåˆ—çŠ¶æ€
        function updateQueueStatus() {
            const status = globalRequestQueue.getStatus();
            
            document.getElementById('queueLength').textContent = status.queueLength;
            document.getElementById('runningTasks').textContent = status.running;
            
            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            const statusIndicator = document.getElementById('systemStatus');
            const statusText = document.getElementById('systemStatusText');
            
            if (status.queueLength > 10) {
                statusIndicator.className = 'status-indicator status-error';
                statusText.textContent = 'è´Ÿè½½è¿‡é«˜';
            } else if (status.queueLength > 5) {
                statusIndicator.className = 'status-indicator status-warning';
                statusText.textContent = 'è´Ÿè½½è¾ƒé«˜';
            } else {
                statusIndicator.className = 'status-indicator status-normal';
                statusText.textContent = 'æ­£å¸¸è¿è¡Œ';
            }
            
            // æ›´æ–°é˜Ÿåˆ—è¯¦æƒ…
            updateQueueDetails(status);
        }
        
        // æ›´æ–°é˜Ÿåˆ—è¯¦æƒ…æ˜¾ç¤º
        function updateQueueDetails(status) {
            const queueDetails = document.getElementById('queueDetails');
            
            if (status.queueLength === 0) {
                queueDetails.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— å¾…å¤„ç†è¯·æ±‚</div>';
                return;
            }
            
            let html = '';
            // æ¨¡æ‹Ÿé˜Ÿåˆ—é¡¹æ˜¾ç¤º
            for (let i = 0; i < Math.min(status.queueLength, 5); i++) {
                html += `
                    <div class="queue-item">
                        <span>è¯·æ±‚ #${performanceStats.totalRequests + i + 1}</span>
                        <span>ç­‰å¾…ä¸­...</span>
                    </div>
                `;
            }
            
            if (status.queueLength > 5) {
                html += `<div style="text-align: center; padding: 10px; color: #666;">
                    è¿˜æœ‰ ${status.queueLength - 5} ä¸ªè¯·æ±‚...
                </div>`;
            }
            
            queueDetails.innerHTML = html;
        }
        
        // æ›´æ–°æ€§èƒ½æŒ‡æ ‡
        function updatePerformanceMetrics() {
            const total = performanceStats.successfulRequests + performanceStats.failedRequests;
            const successRate = total > 0 ? (performanceStats.successfulRequests / total * 100).toFixed(1) : 0;
            const avgResponseTime = performanceStats.responseTimes.length > 0 ? 
                (performanceStats.responseTimes.reduce((a, b) => a + b, 0) / performanceStats.responseTimes.length).toFixed(0) : 0;
            const cacheHitRate = (performanceStats.cacheHits + performanceStats.cacheMisses) > 0 ?
                (performanceStats.cacheHits / (performanceStats.cacheHits + performanceStats.cacheMisses) * 100).toFixed(1) : 0;
            
            document.getElementById('avgResponseTime').textContent = avgResponseTime;
            document.getElementById('cacheHitRate').textContent = cacheHitRate + '%';
        }
        
        // æ›´æ–°æ•°æ®ç»Ÿè®¡
        async function updateDataStats() {
            try {
                // è·å–å‚ä¸è€…æ€»æ•°
                const { count, error } = await supabaseClient
                    .from('participants')
                    .select('*', { count: 'exact', head: true });
                
                if (!error) {
                    document.getElementById('totalParticipants').textContent = count || 0;
                }
                
                // æ¨¡æ‹Ÿä»Šæ—¥æ“ä½œæ•°
                document.getElementById('todayOperations').textContent = performanceStats.totalRequests;
                
            } catch (error) {
                console.error('æ•°æ®ç»Ÿè®¡æ›´æ–°å¤±è´¥:', error);
            }
        }
        
        // æ›´æ–°å›¾è¡¨
        function updateCharts() {
            const chartContainer = document.getElementById('responseTimeChart');
            
            // ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®ç‚¹
            if (responseTimeHistory.length === 0) {
                // åˆå§‹åŒ–æ•°æ®
                for (let i = 0; i < 20; i++) {
                    responseTimeHistory.push(Math.random() * 100 + 50);
                }
            }
            
            // æ·»åŠ æ–°æ•°æ®ç‚¹
            const newPoint = performanceStats.responseTimes.length > 0 ? 
                performanceStats.responseTimes[performanceStats.responseTimes.length - 1] : 
                (Math.random() * 100 + 50);
            
            responseTimeHistory.push(newPoint);
            if (responseTimeHistory.length > 20) {
                responseTimeHistory.shift();
            }
            
            // æ›´æ–°å›¾è¡¨æ˜¾ç¤º
            const maxValue = Math.max(...responseTimeHistory);
            chartContainer.innerHTML = responseTimeHistory
                .map(value => {
                    const height = maxValue > 0 ? (value / maxValue * 100) : 0;
                    return `<div class="chart-bar" style="height: ${height}%"></div>`;
                })
                .join('');
        }
        
        // æ¸…ç©ºé˜Ÿåˆ—
        function clearQueue() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¾…å¤„ç†è¯·æ±‚å—ï¼Ÿ')) {
                globalRequestQueue.clear();
                showToast('é˜Ÿåˆ—å·²æ¸…ç©º', 'success');
                refreshData();
            }
        }
        
        // é‡ç½®ç»Ÿè®¡
        function resetStats() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰ç»Ÿè®¡æ•°æ®å—ï¼Ÿ')) {
                performanceStats = {
                    totalRequests: 0,
                    successfulRequests: 0,
                    failedRequests: 0,
                    responseTimes: [],
                    cacheHits: 0,
                    cacheMisses: 0
                };
                responseTimeHistory = [];
                showToast('ç»Ÿè®¡æ•°æ®å·²é‡ç½®', 'success');
                refreshData();
            }
        }
        
        // å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤ºæç¤º
        function showToast(message, type = 'info') {
            // ç®€å•çš„æç¤ºå®ç°
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed; top: 20px; right: 20px; 
                padding: 15px 20px; border-radius: 4px; 
                background: ${type === 'success' ? '#52c41a' : type === 'error' ? '#ff4d4f' : '#1890ff'};
                color: white; z-index: 10001; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initMonitoring);
    </script>
</body>
</html>