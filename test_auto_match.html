<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªåŠ¨åŒ¹é…åŠŸèƒ½æµ‹è¯•</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 26px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #1890ff;
        }
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        .auto-match-result {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            display: none;
        }
        .auto-match-loading {
            text-align: center;
            padding: 20px;
            color: #1890ff;
        }
        .auto-match-empty {
            text-align: center;
            padding: 30px;
            color: #8c8c8c;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 style="text-align: center; color: #1890ff; margin-bottom: 30px;">ğŸ¤– è‡ªåŠ¨åŒ¹é…åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="card">
            <div class="card-header">
                <h2>ğŸ“‹ æµ‹è¯•ç™»è®°ç»„é˜Ÿ</h2>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="nameInput">å°çº¢ä¹¦å·ï¼šID <span class="required">*</span></label>
                    <input type="text" id="nameInput" placeholder="ä¾‹å¦‚ï¼š2789378855" class="form-control" value="2789378855">
                </div>
                <div class="form-group">
                    <label for="scoreInput">èŠéº»åˆ† (350-950) <span class="required">*</span></label>
                    <input type="number" id="scoreInput" min="350" max="950" placeholder="ä¾‹å¦‚ï¼š829" class="form-control" value="829">
                </div>
                <button class="btn btn-primary btn-block" onclick="addTestParticipant()">
                    <span class="btn-icon">âœš</span> ç™»è®°ç»„é˜Ÿ
                </button>
                
                <!-- è‡ªåŠ¨åŒ¹é…å¼€å…³ -->
                <div class="form-group" style="margin-top: 15px; padding: 12px; background: #f0f8ff; border-radius: 8px; border: 1px solid #d1e7ff;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <label style="font-weight: 600; color: #1a365d; margin-bottom: 5px; display: block;">
                                ğŸ¤– è‡ªåŠ¨åŒ¹é…é˜Ÿå‹
                            </label>
                            <small style="color: #4a5568; font-size: 0.85rem;">
                                ç™»è®°åè‡ªåŠ¨æ˜¾ç¤ºåŒ…å«è¯¥ç”¨æˆ·çš„æ‰€æœ‰é˜Ÿä¼
                            </small>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="autoMatchToggle" onchange="toggleAutoMatch(this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è‡ªåŠ¨åŒ¹é…ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
        <div id="autoMatchResult" class="auto-match-result">
            <div class="card-header">
                <h3 style="margin: 0; color: #1890ff;">ğŸ¤– è‡ªåŠ¨åŒ¹é…ç»“æœ</h3>
            </div>
            <div id="autoMatchContent" style="margin-top: 15px;">
                <div class="auto-match-empty">
                    <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ¤–</div>
                    <p>è¯·å…ˆå¼€å¯è‡ªåŠ¨åŒ¹é…åŠŸèƒ½å¹¶æ·»åŠ å‚ä¸è€…</p>
                </div>
            </div>
        </div>
        
        <!-- æµ‹è¯•æ—¥å¿— -->
        <div class="card" style="margin-top: 20px;">
            <div class="card-header">
                <h3>ğŸ“‹ æµ‹è¯•æ—¥å¿—</h3>
            </div>
            <div class="card-body">
                <div id="testLog" style="background: #000; color: #00ff00; padding: 15px; border-radius: 5px; font-family: monospace; height: 200px; overflow-y: auto;">
                    [ç³»ç»Ÿ] è‡ªåŠ¨åŒ¹é…åŠŸèƒ½æµ‹è¯•å·²å¯åŠ¨
                </div>
                <div style="margin-top: 15px; text-align: center;">
                    <button class="btn btn-outline" onclick="clearTestLog()">æ¸…ç©ºæ—¥å¿—</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æµ‹è¯•æ•°æ®
        let participants = [];
        let allCombinations = [];
        let isAutoMatchEnabled = false;
        let lastAddedParticipant = null;
        const TARGET_SCORE = 2026;
        
        // å·¥å…·å‡½æ•°
        function showToast(message, type = 'info') {
            const colors = {
                success: '#52c41a',
                error: '#ff4d4f',
                warning: '#faad14',
                info: '#1890ff'
            };
            
            const logElement = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearTestLog() {
            document.getElementById('testLog').innerHTML = '[ç³»ç»Ÿ] æ—¥å¿—å·²æ¸…ç©º\n';
        }
        
        // è‡ªåŠ¨åŒ¹é…åŠŸèƒ½
        function toggleAutoMatch(enabled) {
            isAutoMatchEnabled = enabled;
            
            const resultArea = document.getElementById('autoMatchResult');
            if (enabled) {
                resultArea.style.display = 'block';
                showToast('âœ… è‡ªåŠ¨åŒ¹é…å·²å¼€å¯', 'success');
                // å¦‚æœå·²ç»æœ‰å‚ä¸è€…ä¸”æœ€è¿‘æ·»åŠ äº†ç”¨æˆ·ï¼Œç«‹å³æ˜¾ç¤ºç»“æœ
                if (lastAddedParticipant && participants.length > 0) {
                    performAutoMatch(lastAddedParticipant.name);
                }
            } else {
                resultArea.style.display = 'none';
                showToast('âŒ è‡ªåŠ¨åŒ¹é…å·²å…³é—­', 'info');
            }
        }
        
        async function performAutoMatch(xiaohongshuId) {
            const resultContent = document.getElementById('autoMatchContent');
            
            if (!xiaohongshuId) {
                resultContent.innerHTML = `
                    <div class="auto-match-empty">
                        <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ¤”</div>
                        <p>è¯·è¾“å…¥å°çº¢ä¹¦å·å¼€å§‹è‡ªåŠ¨åŒ¹é…</p>
                    </div>
                `;
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            resultContent.innerHTML = `
                <div class="auto-match-loading">
                    <div style="font-size: 2rem; margin-bottom: 10px; animation: spin 1s linear infinite;">ğŸ”„</div>
                    <p>æ­£åœ¨ä¸º ${xiaohongshuId} å¯»æ‰¾åŒ¹é…çš„é˜Ÿå‹...</p>
                </div>
            `;
            
            showToast(`ğŸ” å¼€å§‹ä¸º ${xiaohongshuId} è‡ªåŠ¨åŒ¹é…`);
            
            try {
                // æ¨¡æ‹ŸåŒ¹é…å»¶è¿Ÿ
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°åŒ¹é…
                if (allCombinations.length === 0 || participants.length < 2) {
                    if (participants.length < 2) {
                        resultContent.innerHTML = `
                            <div class="auto-match-empty">
                                <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ‘¥</div>
                                <p>è‡³å°‘éœ€è¦2ä¸ªå‚ä¸è€…æ‰èƒ½è¿›è¡ŒåŒ¹é…</p>
                                <p style="font-size: 0.9rem; color: #8c8c8c; margin-top: 10px;">
                                    å½“å‰åªæœ‰ ${participants.length} ä¸ªå‚ä¸è€…
                                </p>
                            </div>
                        `;
                        showToast('âš ï¸ å‚ä¸è€…ä¸è¶³ï¼Œæ— æ³•åŒ¹é…', 'warning');
                        return;
                    }
                    
                    // æ‰§è¡Œæ¨¡æ‹ŸåŒ¹é…
                    showToast('ğŸ”„ æ‰§è¡ŒåŒ¹é…è®¡ç®—...', 'info');
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    allCombinations = generateMockCombinations();
                    showToast(`âœ… åŒ¹é…å®Œæˆï¼Œæ‰¾åˆ° ${allCombinations.length} ä¸ªç»„åˆ`, 'success');
                }
                
                // æŸ¥è¯¢åŒ…å«è¯¥å°çº¢ä¹¦å·çš„ç»„åˆ
                const filtered = allCombinations.filter(combo => 
                    combo.members.some(member => member.name === xiaohongshuId)
                );
                
                showToast(`ğŸ¯ æ‰¾åˆ° ${filtered.length} ä¸ªåŒ…å« ${xiaohongshuId} çš„ç»„åˆ`, 'success');
                
                // æ˜¾ç¤ºç»“æœ
                renderAutoMatchResult(filtered, xiaohongshuId);
                
            } catch (error) {
                console.error('è‡ªåŠ¨åŒ¹é…å¤±è´¥:', error);
                resultContent.innerHTML = `
                    <div class="auto-match-empty" style="color: #ff4d4f;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">âŒ</div>
                        <p>è‡ªåŠ¨åŒ¹é…å¤±è´¥</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">${error.message}</p>
                    </div>
                `;
                showToast(`âŒ è‡ªåŠ¨åŒ¹é…å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function renderAutoMatchResult(combos, xiaohongshuId) {
            const resultContent = document.getElementById('autoMatchContent');
            
            if (combos.length === 0) {
                resultContent.innerHTML = `
                    <div class="auto-match-empty">
                        <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ”</div>
                        <p>æœªæ‰¾åˆ°åŒ…å« ${xiaohongshuId} çš„ç»„åˆ</p>
                        <p style="font-size: 0.9rem; color: #8c8c8c; margin-top: 10px;">
                            å»ºè®®æ·»åŠ æ›´å¤šå‚ä¸è€…æˆ–è°ƒæ•´åˆ†æ•°åé‡æ–°åŒ¹é…
                        </p>
                        <button class="btn btn-primary" style="margin-top: 15px;" onclick="generateMoreParticipants()">
                            <span class="btn-icon">ğŸ‘¥</span> æ·»åŠ æ›´å¤šå‚ä¸è€…
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #e6f7ff 0%, #f6ffed 100%); border-radius: 8px;">
                    <div style="font-size: 1.5rem; color: #1890ff; font-weight: bold; margin-bottom: 8px;">
                        ğŸ¯ æ‰¾åˆ° ${combos.length} ä¸ªåŒ…å« ${xiaohongshuId} çš„ç»„åˆ
                    </div>
                    <div style="color: #595959; font-size: 0.95rem;">
                        ç³»ç»Ÿå·²è‡ªåŠ¨ä¸ºæ‚¨åŒ¹é…åˆ°åˆé€‚çš„é˜Ÿå‹
                    </div>
                </div>
            `;
            
            combos.forEach((combo, index) => {
                const membersHtml = combo.members.map(member => {
                    const isTarget = member.name === xiaohongshuId;
                    
                    return `
                        <div class="member-item" style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 10px;
                            border: ${isTarget ? '2px solid #1890ff' : '1px solid #d9d9d9'};
                            border-radius: 6px;
                            margin-bottom: 8px;
                            background: ${isTarget ? '#e6f7ff' : 'white'};
                        ">
                            <div>
                                <div class="member-id" style="font-weight: bold; color: #1890ff;">${member.id}</div>
                                <div class="member-name" style="${isTarget ? 'color: #1890ff; font-weight: bold;' : ''}">
                                    ${member.name}
                                </div>
                            </div>
                            <div class="member-score" style="font-size: 1.2rem; font-weight: bold; color: #1677ff;">
                                ${member.score}åˆ†
                            </div>
                        </div>
                    `;
                }).join('');
                
                html += `
                    <div class="combo-card" style="margin-bottom: 20px;">
                        <div class="combo-header">
                            <div class="combo-index">ç»„åˆ #${index + 1}</div>
                            <div class="combo-total">${TARGET_SCORE} åˆ†</div>
                        </div>
                        <div class="combo-members">
                            ${membersHtml}
                        </div>
                    </div>
                `;
            });
            
            html += `
                <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #e8e8e8;">
                    <button class="btn btn-outline" onclick="clearAutoMatchResult()" style="margin-right: 10px;">
                        <span class="btn-icon">ğŸ—‘ï¸</span> æ¸…ç©ºç»“æœ
                    </button>
                    <button class="btn btn-primary" onclick="generateMoreParticipants()">
                        <span class="btn-icon">ğŸ‘¥</span> æ·»åŠ æ›´å¤šå‚ä¸è€…
                    </button>
                </div>
            `;
            
            resultContent.innerHTML = html;
        }
        
        function clearAutoMatchResult() {
            const resultContent = document.getElementById('autoMatchContent');
            resultContent.innerHTML = `
                <div class="auto-match-empty">
                    <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ¤–</div>
                    <p>è‡ªåŠ¨åŒ¹é…ç»“æœå·²æ¸…ç©º</p>
                    <p style="font-size: 0.9rem; color: #8c8c8c; margin-top: 10px;">
                        ä¸‹æ¬¡ç™»è®°æ—¶å°†è‡ªåŠ¨æ˜¾ç¤ºåŒ¹é…ç»“æœ
                    </p>
                </div>
            `;
            showToast('ğŸ—‘ï¸ è‡ªåŠ¨åŒ¹é…ç»“æœå·²æ¸…ç©º', 'info');
        }
        
        // æµ‹è¯•åŠŸèƒ½
        function addTestParticipant() {
            const nameInput = document.getElementById('nameInput');
            const scoreInput = document.getElementById('scoreInput');
            
            const name = nameInput.value.trim();
            const score = parseInt(scoreInput.value);
            
            if (!name || isNaN(score)) {
                showToast('âŒ è¯·è¾“å…¥å®Œæ•´ä¿¡æ¯', 'error');
                return;
            }
            
            const participantId = 'P' + String(Date.now()).slice(-6);
            const participant = { id: participantId, name, score, created_at: new Date().toISOString() };
            
            participants.unshift(participant);
            lastAddedParticipant = participant;
            
            showToast(`âœ… ${name} å·²æ·»åŠ  (ID: ${participantId}, åˆ†æ•°: ${score})`, 'success');
            
            nameInput.value = '';
            scoreInput.value = '';
            
            // å¦‚æœå¯ç”¨äº†è‡ªåŠ¨åŒ¹é…ï¼Œæ‰§è¡Œè‡ªåŠ¨åŒ¹é…
            if (isAutoMatchEnabled) {
                setTimeout(() => {
                    performAutoMatch(name);
                }, 500);
            }
        }
        
        function generateMockCombinations() {
            // ç”Ÿæˆä¸€äº›æ¨¡æ‹Ÿçš„ç»„åˆæ•°æ®
            const combinations = [];
            if (participants.length >= 3) {
                // åˆ›å»ºå‡ ä¸ªæ¨¡æ‹Ÿç»„åˆ
                combinations.push({
                    members: [participants[0], participants[1], participants[2]],
                    totalScore: TARGET_SCORE
                });
                
                if (participants.length >= 4) {
                    combinations.push({
                        members: [participants[0], participants[1], participants[3]],
                        totalScore: TARGET_SCORE
                    });
                }
            }
            return combinations;
        }
        
        function generateMoreParticipants() {
            // ç”Ÿæˆä¸€äº›é¢å¤–çš„æµ‹è¯•å‚ä¸è€…
            const testNames = ['1234567890', '0987654321', '1111111111', '2222222222'];
            const testScores = [675, 829, 522, 950];
            
            for (let i = 0; i < Math.min(4, testNames.length); i++) {
                const participantId = 'P' + String(Date.now() + i).slice(-6);
                const participant = {
                    id: participantId,
                    name: testNames[i],
                    score: testScores[i],
                    created_at: new Date().toISOString()
                };
                participants.push(participant);
                showToast(`ğŸ‘¥ è‡ªåŠ¨ç”Ÿæˆå‚ä¸è€…: ${testNames[i]} (${testScores[i]}åˆ†)`, 'info');
            }
            
            // é‡æ–°æ‰§è¡Œè‡ªåŠ¨åŒ¹é…
            if (isAutoMatchEnabled && lastAddedParticipant) {
                setTimeout(() => {
                    performAutoMatch(lastAddedParticipant.name);
                }, 500);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', () => {
            showToast('ğŸš€ è‡ªåŠ¨åŒ¹é…åŠŸèƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
            showToast('ğŸ’¡ æµ‹è¯•æ­¥éª¤ï¼š', 'info');
            showToast('   1. å¼€å¯"è‡ªåŠ¨åŒ¹é…é˜Ÿå‹"å¼€å…³', 'info');
            showToast('   2. ç‚¹å‡»"ç™»è®°ç»„é˜Ÿ"æ·»åŠ å‚ä¸è€…', 'info');
            showToast('   3. è§‚å¯Ÿè‡ªåŠ¨åŒ¹é…ç»“æœæ˜¾ç¤º', 'info');
            showToast('   4. å¯ä»¥ç‚¹å‡»"æ·»åŠ æ›´å¤šå‚ä¸è€…"ç”Ÿæˆæµ‹è¯•æ•°æ®', 'info');
        });
    </script>
</body>
</html>