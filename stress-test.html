<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿå‹åŠ›æµ‹è¯•å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .test-controls { 
            background: #f0f8ff; 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
        }
        .control-group { 
            margin: 15px 0; 
        }
        label { 
            display: inline-block; 
            width: 120px; 
            font-weight: bold; 
        }
        input, select { 
            padding: 8px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            width: 150px; 
        }
        button { 
            padding: 10px 20px; 
            background: #1890ff; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px; 
        }
        button:hover { 
            background: #40a9ff; 
        }
        button:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
        }
        .results { 
            background: #fafafa; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 20px 0; 
        }
        .metrics { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin: 20px 0; 
        }
        .metric-card { 
            background: white; 
            padding: 15px; 
            border-radius: 6px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            text-align: center; 
        }
        .metric-value { 
            font-size: 1.8em; 
            font-weight: bold; 
            color: #1890ff; 
        }
        .metric-label { 
            color: #666; 
            margin-top: 5px; 
        }
        .progress-bar { 
            width: 100%; 
            height: 20px; 
            background: #f0f0f0; 
            border-radius: 10px; 
            overflow: hidden; 
            margin: 10px 0; 
        }
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #1890ff, #40a9ff); 
            width: 0%; 
            transition: width 0.3s ease; 
        }
        .log { 
            height: 200px; 
            overflow-y: auto; 
            background: #000; 
            color: #00ff00; 
            padding: 10px; 
            font-family: monospace; 
            border-radius: 4px; 
            margin: 15px 0; 
        }
        .status-running { color: #52c41a; }
        .status-stopped { color: #ff4d4f; }
        .status-paused { color: #faad14; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¬ ç³»ç»Ÿå‹åŠ›æµ‹è¯•å·¥å…·</h1>
        <p>æ¨¡æ‹Ÿé«˜å¹¶å‘è®¿é—®ï¼Œæµ‹è¯•ç³»ç»Ÿæ€§èƒ½å’Œç¨³å®šæ€§</p>
        
        <div class="test-controls">
            <h3>âš™ï¸ æµ‹è¯•é…ç½®</h3>
            
            <div class="control-group">
                <label>å¹¶å‘ç”¨æˆ·æ•°:</label>
                <input type="number" id="concurrentUsers" value="10" min="1" max="100">
                <span style="color: #666; margin-left: 10px;">å»ºè®®: 5-20</span>
            </div>
            
            <div class="control-group">
                <label>è¯·æ±‚é—´éš”:</label>
                <input type="number" id="requestInterval" value="100" min="10" max="5000"> ms
                <span style="color: #666; margin-left: 10px;">è¯·æ±‚é—´çš„æ—¶é—´é—´éš”</span>
            </div>
            
            <div class="control-group">
                <label>æµ‹è¯•æŒç»­æ—¶é—´:</label>
                <input type="number" id="testDuration" value="60" min="10" max="300"> ç§’
                <span style="color: #666; margin-left: 10px;">æµ‹è¯•è¿è¡Œæ€»æ—¶é—´</span>
            </div>
            
            <div class="control-group">
                <label>æµ‹è¯•ç±»å‹:</label>
                <select id="testType">
                    <option value="read">è¯»å–æ“ä½œ</option>
                    <option value="write">å†™å…¥æ“ä½œ</option>
                    <option value="mixed">æ··åˆæ“ä½œ</option>
                    <option value="calculate">è®¡ç®—æ“ä½œ</option>
                </select>
            </div>
            
            <div style="margin-top: 20px;">
                <button id="startBtn" onclick="startTest()">â–¶ï¸ å¼€å§‹æµ‹è¯•</button>
                <button id="pauseBtn" onclick="pauseTest()" disabled>â¸ï¸ æš‚åœ</button>
                <button id="stopBtn" onclick="stopTest()" disabled>â¹ï¸ åœæ­¢</button>
                <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
            </div>
        </div>
        
        <div class="metrics">
            <div class="metric-card">
                <div class="metric-value" id="totalRequests">0</div>
                <div class="metric-label">æ€»è¯·æ±‚æ•°</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="successfulRequests">0</div>
                <div class="metric-label">æˆåŠŸè¯·æ±‚æ•°</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="failedRequests">0</div>
                <div class="metric-label">å¤±è´¥è¯·æ±‚æ•°</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="avgResponseTime">0</div>
                <div class="metric-label">å¹³å‡å“åº”æ—¶é—´(ms)</div>
            </div>
        </div>
        
        <div class="results">
            <h3>ğŸ“Š æµ‹è¯•è¿›åº¦</h3>
            <div>æµ‹è¯•çŠ¶æ€: <span id="testStatus" class="status-stopped">å·²åœæ­¢</span></div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div>è¿›åº¦: <span id="progressText">0%</span></div>
            <div>é¢„è®¡å‰©ä½™æ—¶é—´: <span id="remainingTime">--:--</span></div>
        </div>
        
        <div class="results">
            <h3>ğŸ“ æµ‹è¯•æ—¥å¿—</h3>
            <div class="log" id="testLog"></div>
        </div>
    </div>

    <script>
        // æµ‹è¯•æ§åˆ¶å˜é‡
        let isTesting = false;
        let isPaused = false;
        let testStartTime = 0;
        let completedRequests = 0;
        let totalRequests = 0;
        let successfulRequests = 0;
        let failedRequests = 0;
        let responseTimes = [];
        let activeWorkers = [];
        let testTimer = null;
        
        // æµ‹è¯•é…ç½®
        const testConfig = {
            concurrentUsers: 10,
            requestInterval: 100,
            testDuration: 60,
            testType: 'read'
        };
        
        // æ—¥å¿—è®°å½•
        function log(message, type = 'info') {
            const logElement = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        function updateStats() {
            document.getElementById('totalRequests').textContent = completedRequests;
            document.getElementById('successfulRequests').textContent = successfulRequests;
            document.getElementById('failedRequests').textContent = failedRequests;
            
            const avgTime = responseTimes.length > 0 ? 
                (responseTimes.reduce((a, b) => a + b, 0) / responseTimes.length).toFixed(0) : 0;
            document.getElementById('avgResponseTime').textContent = avgTime;
        }
        
        // æ›´æ–°è¿›åº¦æ˜¾ç¤º
        function updateProgress() {
            if (!isTesting) return;
            
            const elapsed = (Date.now() - testStartTime) / 1000;
            const progress = Math.min(elapsed / testConfig.testDuration, 1);
            const percentage = (progress * 100).toFixed(1);
            
            document.getElementById('progressFill').style.width = `${percentage}%`;
            document.getElementById('progressText').textContent = `${percentage}%`;
            
            const remaining = testConfig.testDuration - elapsed;
            if (remaining > 0) {
                const minutes = Math.floor(remaining / 60);
                const seconds = Math.floor(remaining % 60);
                document.getElementById('remainingTime').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                document.getElementById('remainingTime').textContent = '00:00';
            }
        }
        
        // å¼€å§‹æµ‹è¯•
        function startTest() {
            // è·å–é…ç½®
            testConfig.concurrentUsers = parseInt(document.getElementById('concurrentUsers').value);
            testConfig.requestInterval = parseInt(document.getElementById('requestInterval').value);
            testConfig.testDuration = parseInt(document.getElementById('testDuration').value);
            testConfig.testType = document.getElementById('testType').value;
            
            // é‡ç½®çŠ¶æ€
            isTesting = true;
            isPaused = false;
            testStartTime = Date.now();
            completedRequests = 0;
            successfulRequests = 0;
            failedRequests = 0;
            responseTimes = [];
            activeWorkers = [];
            
            // æ›´æ–°UI
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('testStatus').className = 'status-running';
            document.getElementById('testStatus').textContent = 'è¿è¡Œä¸­';
            
            log(`ğŸš€ å¼€å§‹å‹åŠ›æµ‹è¯• - å¹¶å‘ç”¨æˆ·: ${testConfig.concurrentUsers}, ç±»å‹: ${testConfig.testType}`);
            
            // å¯åŠ¨å·¥ä½œçº¿ç¨‹
            for (let i = 0; i < testConfig.concurrentUsers; i++) {
                startWorker(i);
            }
            
            // å¯åŠ¨è¿›åº¦æ›´æ–°
            testTimer = setInterval(() => {
                updateProgress();
                if ((Date.now() - testStartTime) / 1000 >= testConfig.testDuration) {
                    stopTest();
                }
            }, 1000);
        }
        
        // æš‚åœæµ‹è¯•
        function pauseTest() {
            isPaused = !isPaused;
            
            if (isPaused) {
                document.getElementById('pauseBtn').textContent = 'â–¶ï¸ ç»§ç»­';
                document.getElementById('testStatus').className = 'status-paused';
                document.getElementById('testStatus').textContent = 'å·²æš‚åœ';
                log('â¸ï¸ æµ‹è¯•å·²æš‚åœ');
            } else {
                document.getElementById('pauseBtn').textContent = 'â¸ï¸ æš‚åœ';
                document.getElementById('testStatus').className = 'status-running';
                document.getElementById('testStatus').textContent = 'è¿è¡Œä¸­';
                log('â–¶ï¸ æµ‹è¯•å·²ç»§ç»­');
            }
        }
        
        // åœæ­¢æµ‹è¯•
        function stopTest() {
            isTesting = false;
            isPaused = false;
            
            // æ¸…ç†å®šæ—¶å™¨
            if (testTimer) {
                clearInterval(testTimer);
                testTimer = null;
            }
            
            // åœæ­¢æ‰€æœ‰å·¥ä½œçº¿ç¨‹
            activeWorkers.forEach(worker => {
                if (worker.timer) clearInterval(worker.timer);
            });
            activeWorkers = [];
            
            // æ›´æ–°UI
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('testStatus').className = 'status-stopped';
            document.getElementById('testStatus').textContent = 'å·²åœæ­¢';
            
            log(`â¹ï¸ æµ‹è¯•å·²åœæ­¢ - æ€»è¯·æ±‚æ•°: ${completedRequests}, æˆåŠŸç‡: ${(successfulRequests/completedRequests*100||0).toFixed(1)}%`);
        }
        
        // å¯åŠ¨å·¥ä½œçº¿ç¨‹
        function startWorker(workerId) {
            const worker = {
                id: workerId,
                timer: null
            };
            
            worker.timer = setInterval(async () => {
                if (!isTesting || isPaused) return;
                
                try {
                    const startTime = Date.now();
                    
                    // æ‰§è¡Œæµ‹è¯•æ“ä½œ
                    await executeTestOperation();
                    
                    const responseTime = Date.now() - startTime;
                    responseTimes.push(responseTime);
                    
                    successfulRequests++;
                    completedRequests++;
                    
                    if (completedRequests % 10 === 0) {
                        log(`âœ… Worker ${workerId}: è¯·æ±‚æˆåŠŸ (${responseTime}ms)`);
                    }
                    
                } catch (error) {
                    failedRequests++;
                    completedRequests++;
                    log(`âŒ Worker ${workerId}: è¯·æ±‚å¤±è´¥ - ${error.message}`);
                }
                
                updateStats();
                
            }, testConfig.requestInterval);
            
            activeWorkers.push(worker);
        }
        
        // æ‰§è¡Œæµ‹è¯•æ“ä½œ
        async function executeTestOperation() {
            switch (testConfig.testType) {
                case 'read':
                    // è¯»å–æ“ä½œ - è·å–å‚ä¸è€…åˆ—è¡¨
                    await supabaseClient.from('participants').select('*').limit(10);
                    break;
                    
                case 'write':
                    // å†™å…¥æ“ä½œ - æ·»åŠ æµ‹è¯•å‚ä¸è€…
                    const testName = `test_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
                    const testScore = Math.floor(Math.random() * 100) + 1;
                    await supabaseClient.from('participants').insert([
                        { name: testName, score: testScore }
                    ]);
                    break;
                    
                case 'mixed':
                    // æ··åˆæ“ä½œ - éšæœºè¯»å†™
                    if (Math.random() > 0.5) {
                        await executeTestOperation.call(this, 'read');
                    } else {
                        await executeTestOperation.call(this, 'write');
                    }
                    break;
                    
                case 'calculate':
                    // è®¡ç®—æ“ä½œ - è§¦å‘åŒ¹é…è®¡ç®—
                    // è¿™é‡Œæ¨¡æ‹Ÿè®¡ç®—æ“ä½œ
                    await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 500));
                    break;
            }
        }
        
        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('testLog').textContent = '';
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            log('ğŸ”§ å‹åŠ›æµ‹è¯•å·¥å…·å·²å°±ç»ª');
            log('ğŸ’¡ è¯·é…ç½®æµ‹è¯•å‚æ•°åç‚¹å‡»å¼€å§‹æµ‹è¯•');
        });
    </script>
</body>
</html>